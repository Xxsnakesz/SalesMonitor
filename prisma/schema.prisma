generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GM
  AM
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  username      String?      @unique
  name          String
  password      String
  role          Role
  departmentId  String?
  managerId     String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  department    Department?  @relation("UserDepartment", fields: [departmentId], references: [id])
  managedDepartment Department? @relation("DepartmentGM")
  customers     Customer[]   @relation("AMCustomers")
  targets       Target[]
  progresses    Progress[]

  @@index([role])
  @@index([departmentId])
}

model Department {
  id        String     @id @default(uuid())
  name      String     @unique
  gmId      String?    @unique
  createdAt DateTime   @default(now())

  gm        User?      @relation("DepartmentGM", fields: [gmId], references: [id])
  users     User[]     @relation("UserDepartment")
  targets   Target[]
}

model Target {
  id           String     @id @default(uuid())
  amount       Decimal    @db.Decimal(18, 2)
  currency     String     @default("IDR")
  month        Int
  year         Int
  departmentId String?
  userId       String?
  createdAt    DateTime   @default(now())

  department   Department? @relation(fields: [departmentId], references: [id])
  user         User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([departmentId])
  @@index([year, month])
}

model Customer {
  id            String     @id @default(uuid())
  amId          String
  companyName   String
  pic           String
  phone         String
  email         String?
  potential     Decimal    @db.Decimal(18, 2)
  timeline      DateTime?
  status        String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  am            User        @relation("AMCustomers", fields: [amId], references: [id])
  progresses    Progress[]

  @@index([amId])
  @@index([status])
  @@index([createdAt])
}

model Progress {
  id          String       @id @default(uuid())
  customerId  String
  amId        String
  date        DateTime     @default(now())
  description String
  status      String
  createdAt   DateTime     @default(now())

  customer    Customer     @relation(fields: [customerId], references: [id])
  am          User         @relation(fields: [amId], references: [id])
  attachments Attachment[]

  @@index([customerId])
  @@index([amId])
}

model Attachment {
  id         String     @id @default(uuid())
  filename   String
  path       String
  size       Int
  mimeType   String
  uploadedBy String
  progressId String?
  createdAt  DateTime   @default(now())

  progress   Progress?  @relation(fields: [progressId], references: [id])
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
}
